version: '3'

name: ynr-dev

volumes:
  psql-data:

services:

  frontend:
    image: ynr:test
    pull_policy: never
    command: gunicorn --reload --log-level=debug ynr.wsgi
    environment:
      RUN_ENV: test
      PGHOST: dbpsql
      CIRCLECI: true
      DJANGO_SETTINGS_MODULE: ynr.settings.testing
      PORT: 8080
    volumes:
      - type: bind
        source: ./ynr
        target: /dc/ynr/code/ynr
    ports: 8080:8080
    depends_on:
      dbpsql:
        condition: service_healthy

  dbpsql:
    image: public.ecr.aws/docker/library/postgres:12.20
    pull_policy: missing
    environment:
      POSTGRES_DB: ynr
      POSTGRES_USER: ynr
      # This is completely insecure: all connections are trusted, without a password.
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - psql-data:/var/lib/postgresql/data
    ports:
      - 54321:5432
